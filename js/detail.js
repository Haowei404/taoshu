"use strict";$(function(){$("#site-nav").load("site-nav.html"),$("#header .public_header").load("public_header.html"),$(".public_tuijiebook").load("public_tuijiebook.html"),$("#footer").load("footer.html");var i,t=decodeURI(location.search.slice(1));i="",getCookie("historyinf")&&getCookie("historyinf").split("&").forEach(function(n){new Promise(function(i){$.ajax({url:"../api/list.php",type:"get",data:{mes:"seleid",id:n},dataType:"json",success:function(n){i(n)}})}).then(function(n){i=' <li>\n                                    <a href="detail.html?'+n[0].id+'">'+n[0].name+"</a>\n                                </li>",$(".historycontent").append(i)})}),$(".clearhistory").click(function(){removeCookie("historyinf"),$(".historycontent").html("")}),new Promise(function(i){$.ajax({type:"get",url:"../api/list.php",data:{id:t,mes:"seleid"},success:function(n){i(n)}})}).then(function(n){var i=JSON.parse(n);if(getCookie("historyinf")){for(var t=getCookie("historyinf").split(),e=0;e<t.length;e++)-1==t[e].indexOf(i[0].id)&&t.push(i[0].id);setCookie("historyinf",t.join("&"))}else setCookie("historyinf",i[0].id);var s="<h1>"+i[0].name+"</h1>";$(".h1_title").html(s);var a=(i[0].old_price-i[0].old_price*i[0].discount/100).toFixed(2),o='<p class="price_d">\n                            淘书价:\n                            <span id="price-txt" class="num">￥'+i[0].new_price+'</span>\n                        </p>\n                        <p class="vip">\n                            贵宾价：贵宾会员尊享全场图书折上折，详见\n                            <a href="">积分及会员等级</a>\n                        </p>\n                        <p class="price_m">\n                            定 价:\n                            <span id="dingjia-txt">￥'+i[0].old_price+'</span>\n                            折 扣:\n                            <span id="zhekou-txt" class="o">'+i[0].discount+'折</span>\n                            立即节省:\n                            <span id="jiesheng-txt">￥'+a+'</span>\n                        </p>\n                        <p class="kucun">\n                            库 存:\n                            <span class="g">有货</span>\n                        </p>\n                        <p class="pinlei">\n                            品 类:\n                            <span>正价</span>\n                        </p>\n                        <div class="yunfei">\n                            运 费：送至\n                            <div id="selected_area">\n                                <a href="javascript:void(0)" id="province">请选择地区</a>\n                                <div id="address" class="address">\n                                    <p class="ks-stdmod-header"></p>\n                                    <div id="address_list" class="ks-stdmod-body">\n\n                                    </div>\n\n                                </div>\n                            </div>\n                            <span id="yunfei"></span>\n                            <span class="youhui">在线支付满98免快递费</span>\n                            <a href="" id="jieshao">运费说明</a>\n                        </div>\n                        <div class="book_detailed">\n                            <p>\n                                作 者:\n                                '+i[0].authors+'\n                            </p>\n                            <p>\n                                出版社:\n                                <a href="">'+i[0].press+'</a>\n                            </p>\n                            <ul class="clearfix">\n                                <li>\n                                    <span>ISBN：9787565006111</span>\n                                    <span>出版时间：'+i[0].time+"</span>\n                                    <span>页数：140</span>\n                                </li>\n                                <li>\n                                    <span>包装：平装</span>\n                                    <span>开本：16开</span>\n                                    <span>字数：</span>\n                                </li>\n                            </ul>\n                        </div>";$(".book_inf").html(o);var c='<span id="content">\n                                <h4>内容简介</h4>\n                                <div id="content_text" class="customize">\n                                    《'+i[0].name+"》简介：\n                                    <br>\n                                    　　"+i[0].summary+'\n                                </div>\n                            </span>\n                            <span id="authintro">\n                                <h4>作者简介</h4>\n                                <div id="authorintro_text" class="customize">\n                                    暂缺《'+i[0].name+'》作者简介\n                                </div>\n                            </span>\n                            <span id="catalog">\n                                <h4>目录</h4>\n                                <div id="catalog_text" class="customize">\n                                    《'+i[0].name+"》目录：\n                                </div>\n                            </span>";$("#detail_all").html(c);var l=i[0].stock;$("#buynum .stock").html(l),$("#buy_num").bind("input propertychange",function(){$("#buy_num").val()-0>l-0&&(alert("超过库存"),$("#buy_num").val(l))}),magniglass({iw:200,ih:200,ele:"book",imglist:i[0].image})}),new Promise(function(i){$.ajax({url:"../api/comm.php",type:"get",data:{mes:"init",uid:getCookie("uid"),goods_id:t},dataType:"json",success:function(n){i(n)}})}).then(function(n){var i="",t=0;n.map(function(n){i+='<p style="margin:10px; overflow:hidden;">\n                            <span class="content" style="float:left">'+n.con+'</span>\n                            <span class="time" style="float:right">'+n.create_time+'</span>\n                            <span class="uname" style="float:right;margin-right:15px">by:'+n.username+"</span>\n                        </p>",t++}).join(""),$(".comm_null").html(i),$("#j_comments li").html("淘书评论("+t+")")}),$("#btn-buy").click(function(){$("#buy_num").val()&&0!=$("#buy_num").val()?getCookie("username")?new Promise(function(i){$.ajax({url:"../api/cart.php",type:"post",data:{mes:"insert",uid:getCookie("uid"),num:$("#buy_num").val(),goods_id:t},success:function(n){i(n)}})}).then(function(n){if("exist"==n)confirm("你已经添加该商品请到购物车查看(按确定跳转到购物车)")&&(location.href="cart.html");else if("yes"==n){$(".ks-overlay").css({display:"block",left:$("#buy_num").offset().left+"px",top:$("#buy_num").offset().top+"px"});var e=0;new Promise(function(i){$.ajax({url:"../api/cart.php",type:"get",data:{mes:"selid",uid:getCookie("uid")},dataType:"json",success:function(n){i(n)}})}).then(function(n){var t=0;n.forEach(function(n){e+=n.number-0;var i=n.number;$("#cartnum").html(e),new Promise(function(i){$.ajax({url:"../api/list.php",type:"get",data:{id:n.goods_id,mes:"seleid"},dataType:"json",success:function(n){i(n)}})}).then(function(n){t+=n[0].new_price*i,$(".ts-price").html(t)})})}),$(".ts-long-btn").click(function(){location.href="cart.html"}),$(".ts-long-btn1").click(function(){$(".ks-overlay").css("display","none")}),$(".ks-ext-close-x").click(function(){$(".ks-overlay").css("display","none")})}}):(alert("您还没登陆，请先登录"),localStorage.url=location.href,location.href="login.html"):alert("请输入购买数量")}),$(".comm-btn").click(function(){var n=filterStr($(".textInput").val());new Promise(function(i){$.ajax({url:"../api/comm.php",type:"get",data:{uid:getCookie("uid"),username:getCookie("username"),goods_id:t,con:n,mes:"insert"},success:function(n){i(n)}})}).then(function(n){$(".textInput").val(""),location.reload()})})});